<div class="pos-container">
  <div class="pos-header">
    <h1><mat-icon>point_of_sale</mat-icon> {{ 'pos.title' | t }}</h1>
  </div>

  <div class="pos-split">
    <div class="scanner-panel">
      <mat-card class="scanner-card">
        <h2>{{ 'pos.scan.title' | t }}</h2>
        <mat-form-field appearance="outline" class="barcode-input">
          <mat-label>{{ 'pos.scan.barcode' | t }}</mat-label>
          <input matInput 
                 #barcodeInput
                 [(ngModel)]="barcode"
                 (keyup.enter)="onBarcodeSubmit()"
                 [placeholder]="'pos.scan.placeholder' | t"
                 autocomplete="off">
          <mat-icon matPrefix>qr_code_scanner</mat-icon>
        </mat-form-field>
      </mat-card>

      @if (lastScannedProduct) {
        <mat-card class="product-preview">
          <h3>{{ 'pos.lastScanned' | t }}</h3>
          <div class="product-details">
            <div class="product-image">
              <mat-icon>diamond</mat-icon>
            </div>
            <div class="product-info">
              <h4>{{ lastScannedProduct.modelName }}</h4>
              <p><strong>{{ 'pos.purity' | t }}:</strong> {{ lastScannedProduct.purityEnum }}</p>
              <p><strong>{{ 'pos.weight' | t }}:</strong> {{ lastScannedProduct.grossWeight }}g</p>
              <p class="price">{{ formatCurrency(lastScannedProduct.estimatedPrice) }} {{ 'unit.egp' | t }}</p>
            </div>
          </div>
        </mat-card>
      }
    </div>

    <div class="cart-panel">
      <mat-card class="cart-card">
        <h2>{{ 'pos.cart.title' | t }}</h2>
        
        @if (cartItems.length > 0) {
          <table mat-table [dataSource]="cartItems" class="cart-table">
            <ng-container matColumnDef="barcode">
              <th mat-header-cell *matHeaderCellDef>{{ 'pos.table.barcode' | t }}</th>
              <td mat-cell *matCellDef="let item"><code>{{ item.barcode }}</code></td>
            </ng-container>

            <ng-container matColumnDef="model">
              <th mat-header-cell *matHeaderCellDef>{{ 'pos.table.product' | t }}</th>
              <td mat-cell *matCellDef="let item">{{ item.modelName }}</td>
            </ng-container>

            <ng-container matColumnDef="weight">
              <th mat-header-cell *matHeaderCellDef>{{ 'pos.table.weight' | t }}</th>
              <td mat-cell *matCellDef="let item">{{ item.grossWeight }}g</td>
            </ng-container>

            <ng-container matColumnDef="qty">
              <th mat-header-cell *matHeaderCellDef>{{ 'pos.table.qty' | t }}</th>
              <td mat-cell *matCellDef="let item">{{ item.quantity }}</td>
            </ng-container>

            <ng-container matColumnDef="price">
              <th mat-header-cell *matHeaderCellDef>{{ 'pos.table.price' | t }}</th>
              <td mat-cell *matCellDef="let item">
                <span class="gold-text">{{ formatCurrency(item.estimatedPrice) }} {{ 'unit.egp' | t }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>{{ 'pos.table.remove' | t }}</th>
              <td mat-cell *matCellDef="let item">
                <button mat-icon-button color="warn" (click)="removeFromCart(item)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        } @else {
          <div class="empty-cart">
            <mat-icon>shopping_cart</mat-icon>
            <p>{{ 'pos.cart.empty' | t }}</p>
          </div>
        }

        <div class="customer-info-section">
          <h3><mat-icon>person</mat-icon> {{ 'pos.customer.title' | t }}</h3>
          <div class="customer-fields">
            <mat-form-field appearance="outline" class="customer-field">
              <mat-label>{{ 'pos.customer.name' | t }}</mat-label>
              <input matInput 
                     [(ngModel)]="customerName" 
                     [placeholder]="'pos.customer.namePlaceholder' | t"
                     required>
              <mat-icon matPrefix>person</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline" class="customer-field">
              <mat-label>{{ 'pos.customer.phone' | t }}</mat-label>
              <input matInput 
                     [(ngModel)]="customerPhone" 
                     [placeholder]="'pos.customer.phonePlaceholder' | t"
                     required>
              <mat-icon matPrefix>phone</mat-icon>
            </mat-form-field>
          </div>

          <div class="gold-rate-display">
            <mat-icon>paid</mat-icon>
            <span><strong>{{ 'pos.goldRate' | t }}:</strong> {{ currentGoldRate }} {{ 'unit.egpPerGram' | t }}</span>
          </div>
        </div>

        <div class="trade-in-section">
          <div class="section-header">
            <h3>{{ 'pos.tradeIn.title' | t }}</h3>
            <button mat-raised-button color="primary" (click)="openAddOldGoldDialog()">
              <mat-icon>add</mat-icon> {{ 'pos.tradeIn.add' | t }}
            </button>
          </div>

          @if (oldGoldItems.length > 0) {
            <div class="old-gold-list">
              @for (item of oldGoldItems; track item) {
                <div class="old-gold-item">
                  <div class="old-gold-info">
                    <strong>{{ item.purity }} - {{ item.weight }}g</strong>
                    <small>ID: {{ item.customerNationalId }}</small>
                  </div>
                  <div class="old-gold-value">
                    <span class="warning-text">- {{ formatCurrency(item.weight * item.buyRate) }} {{ 'unit.egp' | t }}</span>
                    <button mat-icon-button color="warn" (click)="removeOldGold(item)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <div class="cart-footer">
          <div class="total-row">
            <span>{{ 'pos.subtotal' | t }}:</span>
            <span>{{ formatCurrency(getSubtotal()) }} {{ 'unit.egp' | t }}</span>
          </div>
          @if (oldGoldItems.length > 0) {
            <div class="total-row warning-text">
              <span>{{ 'pos.lessOldGold' | t }}:</span>
              <span>- {{ formatCurrency(getOldGoldTotal()) }} {{ 'unit.egp' | t }}</span>
            </div>
          }
          <div class="total-row net-total">
            @if (getNetTotal() >= 0) {
              <span>{{ 'pos.netToPay' | t }}:</span>
              <span class="success-text">{{ formatCurrency(getNetTotal()) }} {{ 'unit.egp' | t }}</span>
            } @else {
              <span>{{ 'pos.changeDue' | t }}:</span>
              <span class="success-text">{{ formatCurrency(getChangeDue()) }} {{ 'unit.egp' | t }}</span>
            }
          </div>

          <div class="action-buttons">
            <button mat-raised-button color="primary" (click)="checkout()" [disabled]="cartItems.length === 0">
              <mat-icon>check_circle</mat-icon> {{ 'pos.checkout' | t }}
            </button>
            <button mat-button color="warn" (click)="clearCart()">
              <mat-icon>cancel</mat-icon> {{ 'pos.cancel' | t }}
            </button>
          </div>
        </div>
      </mat-card>
    </div>
  </div>
</div>
