<div class="settings-container">
  <div class="settings-header">
    <h1><mat-icon>settings</mat-icon> الإعدادات</h1>
    <p class="subtitle">تكوين تفضيلات النظام</p>
  </div>

  <div class="settings-grid">
    <!-- Gold Rate Management -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>currency_exchange</mat-icon>
          إدارة أسعار الذهب
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="goldRateForm" (ngSubmit)="updateGoldRates()">
          <div class="rate-grid">
            <mat-form-field appearance="outline">
              <mat-label>سعر شراء عيار 24 (جنيه/جرام)</mat-label>
              <input matInput type="number" formControlName="karat24Buy" step="0.01">
              <mat-icon matPrefix>attach_money</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>سعر بيع عيار 24 (جنيه/جرام)</mat-label>
              <input matInput type="number" formControlName="karat24Sell" step="0.01">
              <mat-icon matPrefix>sell</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>سعر شراء عيار 21 (جنيه/جرام)</mat-label>
              <input matInput type="number" formControlName="karat21Buy" step="0.01">
              <mat-icon matPrefix>attach_money</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>سعر بيع عيار 21 (جنيه/جرام)</mat-label>
              <input matInput type="number" formControlName="karat21Sell" step="0.01">
              <mat-icon matPrefix>sell</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>سعر شراء عيار 18 (جنيه/جرام)</mat-label>
              <input matInput type="number" formControlName="karat18Buy" step="0.01">
              <mat-icon matPrefix>attach_money</mat-icon>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>سعر بيع عيار 18 (جنيه/جرام)</mat-label>
              <input matInput type="number" formControlName="karat18Sell" step="0.01">
              <mat-icon matPrefix>sell</mat-icon>
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-raised-button color="primary" type="submit" [disabled]="goldRateForm.invalid || saving">
              <mat-icon>save</mat-icon>
              {{ saving ? 'جاري الحفظ...' : 'تحديث أسعار الذهب' }}
            </button>
          </div>
        </form>

        @if (lastUpdated) {
          <div class="last-updated">
            <mat-icon>schedule</mat-icon>
            آخر تحديث: {{ lastUpdated | date:'medium' }}
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- Gold Rate History -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>history</mat-icon>
          Gold Rate History
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <button mat-stroked-button (click)="toggleHistory()" class="toggle-history-btn">
          <mat-icon>{{ showHistory ? 'expand_less' : 'expand_more' }}</mat-icon>
          {{ showHistory ? 'Hide History' : 'Show History' }}
        </button>

        @if (showHistory) {
          @if (loadingHistory) {
            <div class="loading-container">
              <p>Loading history...</p>
            </div>
          } @else if (rateHistory.length > 0) {
            <div class="table-container">
              <table mat-table [dataSource]="rateHistory">
                <ng-container matColumnDef="effectiveDate">
                  <th mat-header-cell *matHeaderCellDef>Date</th>
                  <td mat-cell *matCellDef="let rate">{{ formatDate(rate.effectiveDate) }}</td>
                </ng-container>

                <ng-container matColumnDef="rate24k">
                  <th mat-header-cell *matHeaderCellDef>24K Rate</th>
                  <td mat-cell *matCellDef="let rate">{{ rate.rate24k }} EGP/g</td>
                </ng-container>

                <ng-container matColumnDef="rate21k">
                  <th mat-header-cell *matHeaderCellDef>21K Rate</th>
                  <td mat-cell *matCellDef="let rate">{{ rate.rate21k }} EGP/g</td>
                </ng-container>

                <ng-container matColumnDef="rate18k">
                  <th mat-header-cell *matHeaderCellDef>18K Rate</th>
                  <td mat-cell *matCellDef="let rate">{{ rate.rate18k }} EGP/g</td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="historyColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: historyColumns;"></tr>
              </table>
            </div>

            <mat-paginator
              [length]="totalHistoryElements"
              [pageSize]="historyPageSize"
              [pageSizeOptions]="[5, 10, 20]"
              (page)="onHistoryPageChange($event)">
            </mat-paginator>
          } @else {
            <div class="empty-state">
              <mat-icon>inbox</mat-icon>
              <p>No rate history found.</p>
            </div>
          }
        }
      </mat-card-content>
    </mat-card>

    <!-- System Configuration -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>toggle_on</mat-icon>
          إعدادات النظام
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (loadingConfig) {
          <div class="loading-config">Loading configuration...</div>
        } @else {
          <div class="toggle-row">
            <div class="toggle-info">
              <div class="toggle-title">تحديث أسعار الذهب تلقائياً</div>
              <div class="toggle-subtitle">يُحدّث أسعار الذهب تلقائياً (للمدير فقط)</div>
            </div>
            <mat-slide-toggle
              [checked]="goldAutoUpdateEnabled"
              (change)="onToggleGoldAutoUpdate($event.checked)">
            </mat-slide-toggle>
          </div>

          <div class="toggle-row">
            <div class="toggle-info">
              <div class="toggle-title">تكامل الأجهزة</div>
              <div class="toggle-subtitle">تفعيل الطابعة/درج النقود (للمسؤول فقط)</div>
            </div>
            <mat-slide-toggle
              [checked]="hardwareEnabled"
              (change)="onToggleHardware($event.checked)">
            </mat-slide-toggle>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- System Information -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>info</mat-icon>
          معلومات النظام
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="info-row">
          <span class="info-label">اسم النظام:</span>
          <span class="info-value">AL Mohamadia Jewelry POS</span>
        </div>
        <div class="info-row">
          <span class="info-label">الإصدار:</span>
          <span class="info-value">1.0.0</span>
        </div>
        <div class="info-row">
          <span class="info-label">قاعدة البيانات:</span>
          <span class="info-value">H2 In-Memory</span>
        </div>
        <div class="info-row">
          <span class="info-label">الخادم:</span>
          <span class="info-value">Spring Boot 3.4.1</span>
        </div>
        <div class="info-row">
          <span class="info-label">الواجهة:</span>
          <span class="info-value">Angular 17+</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- User Preferences -->
    <mat-card class="settings-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>tune</mat-icon>
          تفضيلات المستخدم
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="preference-row">
          <mat-icon>language</mat-icon>
          <div class="preference-content">
            <div class="preference-label">اللغة</div>
            <div class="preference-value">العربية</div>
          </div>
        </div>
        <div class="preference-row">
          <mat-icon>currency_pound</mat-icon>
          <div class="preference-content">
            <div class="preference-label">العملة</div>
            <div class="preference-value">جنيه مصري (EGP)</div>
          </div>
        </div>
        <div class="preference-row">
          <mat-icon>scale</mat-icon>
          <div class="preference-content">
            <div class="preference-label">وحدة الوزن</div>
            <div class="preference-value">جرام (g)</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
